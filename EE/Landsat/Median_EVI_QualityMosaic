// Define a function that scales and masks Landsat 8 surface reflectance images
// and adds an NDVI band.
function prepSrL8(image) {
  // Develop masks for unwanted pixels (fill, cloud, cloud shadow).
  var qaMask = image.select('QA_PIXEL').bitwiseAnd(parseInt('11111', 2)).eq(0);
  var saturationMask = image.select('QA_RADSAT').eq(0);

  // Apply the scaling factors to the appropriate bands.
  var opticalBands = image.select('SR_B.').multiply(0.0000275).add(-0.2);
  var thermalBands = image.select('ST_B.*').multiply(0.00341802).add(149.0);

  // Calculate NDVI.
  var ndvi = opticalBands.normalizedDifference(['SR_B5', 'SR_B4'])
      .rename('NDVI');
  
  var evi = opticalBands.expression(
  '2.5 * ((NIR-RED) / (NIR + 6 * RED - 7.5* BLUE +1))', {
    NIR:opticalBands.select('SR_B4'),
    RED:opticalBands.select('SR_B3'),
    BLUE:opticalBands.select('SR_B1')
    
  }).rename('EVI');

  // Replace original bands with scaled bands, add NDVI band, and apply masks.
  return image.addBands(opticalBands, null, true)
      .addBands(thermalBands, null, true)
      .addBands(evi)
      .updateMask(qaMask)
      .updateMask(saturationMask);
}

// Define an arbitrary region of interest as a point.
var roi = ee.Geometry.Point(-39.379279523521916,-16.876492367510767);

// Load a Landsat 8 surface reflectance collection.
var collection = ee.ImageCollection('LANDSAT/LC08/C02/T1_L2')
  // Filter to get only imagery at a point of interest.
  .filterBounds(roi)
  // Filter to get only six months of data.
  .filterDate('2019-01-01', '2022-01-01')
  // Prepare images by mapping the prepSrL8 function over the collection.
  .map(prepSrL8)
  // Select the bands of interest to avoid taking up unneeded memory.
  .select('SR_B.|NDVI');

// Convert the collection to an array.
var array = collection.toArray();

// Label of the axes.
var imageAxis = 0;
var bandAxis = 1;

// Get the EVI slice and the bands of interest.
var bandNames = collection.first().bandNames();
var bands = array.arraySlice(bandAxis, 0, bandNames.length());
var evi = array.arraySlice(bandAxis, -1);

// Sort by descending NDVI.
var sorted = bands.arraySort(evi.multiply(-1));

// Get the highest 20% EVI observations per pixel.
var numImages = sorted.arrayLength(imageAxis).multiply(0.2).int();
var highestEvi = sorted.arraySlice(imageAxis, 0, numImages);

// Get the mean of the highest 20% NDVI observations by reducing
// along the image axis.
var median = highestEvi.arrayReduce({
  reducer: ee.Reducer.median(),
  axes: [imageAxis]
});

// Turn the reduced array image into a multi-band image for display.
var medianImage = median.arrayProject([bandAxis]).arrayFlatten([bandNames]);
Map.centerObject(roi, 12);
Map.addLayer(medianImage, {bands: ['SR_B6', 'SR_B5', 'SR_B4'], min: 0, max: 0.4});


var projection = medianImage.select('SR_B2').projection().getInfo();

var PARK = ee.FeatureCollection("projects/af-phenology/assets/Parks/PNH_Monte_Pascoal");

// Export a cloud-optimized GeoTIFF.
Export.image.toDrive({
  image: medianImage,
  description: 'L8_Median_EVI_Monte_Pascoal',
  crs: projection.crs,
  crsTransform: projection.transform,
  region: PARK.geometry(),
  fileFormat: 'GeoTIFF',
  formatOptions: {
    cloudOptimized: true
  }
});
