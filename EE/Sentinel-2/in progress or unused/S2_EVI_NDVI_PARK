/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var MATA_ESCURA_HECTARES = ee.FeatureCollection("projects/af-phenology/assets/Hectares/1_MataEscura_Hectares_new"),
    S2 = ee.ImageCollection("COPERNICUS/S2_SR"),
    s2Clouds = ee.ImageCollection("COPERNICUS/S2_CLOUD_PROBABILITY"),
    MATA_ESCURA_PARK = ee.FeatureCollection("projects/af-phenology/assets/Parks/REBIO_Mata_Escura");
/***** End of imports. If edited, may not auto-convert in the playground. *****/


// imports
var helpers = require('users/brbell01/AF_Phenology:Helpers');
var constants = require('users/brbell01/AF_Phenology:Constants');

// Constants
var AREA_NAME = 'Mata Escura'
var S2_RED_BAND = 'B4';
var S2_NIR_BAND = 'B8';

var START_DATE = constants.STUDY_START_DATE;
var END_DATE = constants.STUDY_END_DATE;
var MAX_CLOUD_PROBABILITY = 60

//// Functions

var generateIndexChart = function(indexName, imageCollection, featureCollection, regionName) {

  // // Function to calculate average index within the given geometry
  function medianIndex(image, geometry) {
    var stats = image.reduceRegion({
      reducer: ee.Reducer.median(),
      geometry: geometry,
      scale: 10,
      maxPixels: 128000000
    });
    
    return stats.get(indexName);
  }

  //function to get the average of a band over a month in a supplied region
  function getAverageIndex(feature, imageCollection) {
    // filter by bounds
    var filtered = imageCollection.filterBounds(feature.geometry());
    
    var averages = filtered.toList(1000).map(function (image) {
      image = ee.Image(image)
      var median = medianIndex(image, feature.geometry());
      var date = image.date()
      return ee.List([date.format('y-M-d'), median])
    })
    .filter(ee.Filter.listContains('item', null).not())
    
    
    var propertyKey = indexName
    return feature.set(propertyKey, averages)
  }
  
  var meanIndices = featureCollection.map(function(feature) { return getAverageIndex(feature, imageCollection); })
  return meanIndices
}


//////////////////////////////////////////////////////////////////////////
//////////
//Main
/////////
//////////////////////////////////////////////////////////////////////////

// Filter by study dates and park bounds
var filter = ee.Filter.and(
    ee.Filter.bounds(MATA_ESCURA_PARK.geometry()), 
    ee.Filter.date(START_DATE, END_DATE));
    
S2 = S2.filter(filter)
    .map(helpers.S2AddIndices);

var regionName = 'Mata Escura';

// Join S2 SR with cloud probability dataset to add cloud mask.
var s2WithCloudProperty = helpers.s2AddCloudProbability(S2, s2Clouds, filter);
var s2CloudFiltered = s2WithCloudProperty.filterMetadata('CLOUDY_PIXEL_PERCENTAGE', 'less_than', MAX_CLOUD_PROBABILITY);
var s2CloudMasked = helpers.s2MaskClouds(s2WithCloudProperty, MAX_CLOUD_PROBABILITY);

// use whole park
MATA_ESCURA_HECTARES = ee.FeatureCollection(MATA_ESCURA_PARK)

var mata_escura = generateIndexChart(constants.EVI_NAME, S2, MATA_ESCURA_HECTARES, regionName);
mata_escura = generateIndexChart(constants.NDVI_NAME, S2, mata_escura, regionName);

print(mata_escura)

Export.table.toDrive({
  collection: mata_escura,
  description: 'mata_escura_park-s2',
  folder: 'phenology',
  fileFormat: 'CSV',
  selectors: ['Hectare_ID', constants.EVI_NAME, constants.NDVI_NAME]
});
