/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var geometry = ee.FeatureCollection("projects/af-phenology/assets/Parks/PN_Mata_Escura"),
    hectares = ee.FeatureCollection("projects/af-phenology/assets/Hectares/1_MataEscura_Hectares");
/***** End of imports. If edited, may not auto-convert in the playground. *****/
//The purpose of this script is to "ground-truth" the S1 and S2 imagery using and independent data source, 
//using the Planet NICFI hi-resolution archive. Veg. Indices using this imagery can provide values with which to 
//filter features (e.g. reflecting forest type)


var nicfi = ee.ImageCollection("projects/planet-nicfi/assets/basemaps/americas");
var threshold1 = 0.5    //for mean
var threshold2 = 0.02   //for SD

var listOfImages = nicfi.toList(nicfi.size());
print(listOfImages)

showimage = listOfImages.getString([0])

var nicfi2021 = ee.Image('projects/planet-nicfi/assets/basemaps/americas/planet_medres_normalized_analytic_2021-11_mosaic');

Map.centerObject(geometry, 12)

var vis = {"bands":["R","G","B"],"min":0,"max":3000,"gamma":1.8};

Map.addLayer(nicfi2021, vis, '2021-03 mosaic');

//Function to calculate EVI
var addEVI=function(image){
  var EVI = image.expression(
      '2.5 * ((NIR - RED) / (NIR + 6 * RED - 7.5 * BLUE + 1))', {
      'NIR' : image.select('N').divide(10000),
      'RED' : image.select('R').divide(10000),
      'BLUE': image.select('B').divide(10000)}).rename('EVI');
  return image.addBands(EVI);
};

// Map the function over the collection
var nicfi = nicfi.map(addEVI);

// Reduce collection by a median EVI reducer for viewing
var nicfi_evi = nicfi.select('EVI').median()
Map.addLayer(nicfi_evi, {}, 'nicfi EVI');

// Map.addLayer(nicfi.normalizedDifference(['N','R']).rename('NDVI'),
//     {min:-0.55,max:0.8,palette: [
//         '8bc4f9', 'c9995c', 'c7d270','8add60','097210'
//     ]}, 'NDVI', false);
 
//add geometry to visualization
var empty = ee.Image().byte();
var outline = empty.paint({
  featureCollection: geometry,
  color: 1,
  width: 3
}); 
var outline2 = empty.paint({
  featureCollection: hectares,
  color: 1,
  width: 3
}); 
Map.addLayer(outline, {palette: '00FF00'}, 'geometry');
Map.addLayer(outline2, {palette: 'FFFF00'}, 'geometry');


//Chart the average/stdev EVI values for all ROIs
var nicfiEVI = nicfi.select('EVI').mean()

var chart1 = ui.Chart.image.byRegion({
  image: nicfiEVI, 
  regions: hectares,
  reducer: ee.Reducer.mean(),
  scale: 4
})
var chart2 = ui.Chart.image.byRegion({
  image: nicfiEVI, 
  regions: hectares,
  reducer: ee.Reducer.stdDev(),
  scale: 4
})
print(chart1);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
print(chart2);

//Create a filter for the geometry which eliminates polygons 
//where mean and stdev of EVI falls below certain thresholds
//calculate the variance in EVI within each ROI


// //append mean EVI values as property to ROIs

// for(var f=0; f<hect_clip.length; f++) {
//   var feature = ee.Feature(hect_clip[f])

// // Set a property.
//   return feature.set('meanEVI', ee.Number(nicfiEVI.clip(hect_clip[f]).mean())
//                 .set('sdEVI', ee.Number(nicfiEVI.clip(hect_clip[f]).setdev())
// }

// //filter on property
// geom_filtered = hectares
//         .filter(ee.Filter.gte(meanEVI, threshold1))
//         .filter(ee.Filter.gte(sdEVI, threshold2))

